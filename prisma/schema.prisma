generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CLIENT
  ATTORNEY
  ADMIN
}

enum LegalCategory {
  IMMIGRATION   // 移民
  CRIMINAL      // 刑事
  CIVIL         // 民事诉讼
  REAL_ESTATE   // 房产地产
  FAMILY        // 家庭法律
  BUSINESS      // 商业公司
  ESTATE_PLAN   // 信托遗产
  LABOR         // 劳工雇佣
  TAX           // 税务财务
  OTHER         // 其他
}

enum Language {
  MANDARIN
  CANTONESE
  ENGLISH
}

enum FaqAudience {
  GENERAL
  CLIENT
  ATTORNEY
}

enum LegalNoticeType {
  TERMS
  PRIVACY
  ATTORNEY_TERMS
  CLIENT_TERMS
  ADVERTISING_DISCLAIMER
}

enum LegalNoticeStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum CaseStatus {
  OPEN
  MATCHING
  CLOSED
  CANCELLED
}

// Marketplace-style legal fee mode (borrowed interaction structure, legal-specific semantics)
enum FeeMode {
  CONSULTATION
  AGENCY
  STAGED
  HOURLY
  CUSTOM
}

enum UrgencyLevel {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum BidStatus {
  PENDING
  WITHDRAWN
  ACCEPTED
  REJECTED
}

enum ConversationStatus {
  OPEN
  CLOSED
}

enum ConversationRole {
  CLIENT
  ATTORNEY
}

enum ChatSenderRole {
  CLIENT
  ATTORNEY
  SYSTEM
}

enum ConversationReportStatus {
  PENDING
  REVIEWING
  RESOLVED
  DISMISSED
}

enum ConversationReportCategory {
  HARASSMENT
  SPAM
  FRAUD
  THREAT
  INAPPROPRIATE
  PRIVACY
  OTHER
}

enum BlacklistScope {
  CONVERSATION
  GLOBAL
}

enum AdminActionEntityType {
  REPORT
  BLACKLIST
  CONVERSATION
  CASE
  BID
  USER
  ATTORNEY
  SUPPORT_TICKET
  NOTIFICATION
}

enum CaseAttachmentVisibility {
  CLIENT_ONLY
  SELECTED_ATTORNEY
  ADMINS_ONLY
}

enum EngagementStatus {
  DRAFT
  PENDING_CLIENT
  PENDING_ATTORNEY
  ACTIVE
  DECLINED
  CANCELED
}

enum ServiceBoundaryType {
  CONSULTATION
  DOCUMENT_PREP
  COURT_APPEARANCE
  FULL_REPRESENTATION
  CUSTOM
}

enum ConversationTagType {
  HIGH_INTENT
  HIGH_RISK
  MISSING_MATERIALS
  NEEDS_FOLLOWUP
  DISPUTE_RISK
}

enum FollowUpReminderStatus {
  OPEN
  DONE
  DISMISSED
}

enum DisputeTicketStatus {
  OPEN
  UNDER_REVIEW
  WAITING_PARTY
  RESOLVED
  CLOSED
}

enum DisputeTicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ContentRuleScope {
  CASE_POST
  BID_SUBMISSION
  CHAT_MESSAGE
}

enum ContentRuleAction {
  ALLOW
  WARN
  REVIEW
  BLOCK
}

enum PaymentOrderStatus {
  UNPAID
  PENDING_PAYMENT
  PAID_HELD
  PARTIALLY_RELEASED
  RELEASED
  REFUND_PENDING
  REFUNDED
  CHARGEBACK_REVIEW
  CANCELED
}

enum PaymentEventType {
  PAYMENT_INTENT_CREATED
  PAYMENT_SUCCEEDED
  PAYMENT_FAILED
  HOLD_PLACED
  MILESTONE_RELEASE_REQUESTED
  MILESTONE_RELEASED
  REFUND_REQUESTED
  REFUND_APPROVED
  REFUND_COMPLETED
  ADMIN_HOLD
  ADMIN_RELEASE
  DISPUTE_BLOCK
}

enum PaymentMilestoneStatus {
  PENDING
  READY_FOR_RELEASE
  RELEASED
  DISPUTED
  CANCELED
}

enum PaymentReconciliationStatus {
  UNRECONCILED
  MATCHED
  MANUAL_REVIEW
  MISMATCH
  RECONCILED
}

enum PaymentReviewStatus {
  NONE
  PENDING_REVIEW
  APPROVED
  REJECTED
}

enum PaymentHoldReasonCode {
  DISPUTE_BLOCK
  FRAUD_REVIEW
  COMPLIANCE_REVIEW
  DOCUMENT_MISSING
  MANUAL_HOLD
  OTHER
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
}

enum NotificationType {
  DISPUTE_UPDATE
  PAYMENT_UPDATE
  REPORT_UPDATE
  SUPPORT_TICKET_UPDATE
  SYSTEM_NOTICE
}

enum SupportTicketStatus {
  OPEN
  PENDING_PLATFORM
  PENDING_CLIENT
  RESOLVED
  CLOSED
}

enum SupportTicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum SupportTicketCategory {
  GENERAL
  ACCOUNT
  BILLING
  CASE_PROCESS
  PLATFORM_FEEDBACK
  SAFETY
  OTHER
}

enum SupportInboxSourceType {
  REPORT
  DISPUTE
  SUPPORT_TICKET
}

enum SupportInboxQueueLevel {
  CUSTOMER_SERVICE
  RISK
  ADMIN
}

enum AttorneyReviewStatus {
  PENDING_REVIEW
  NEEDS_INFO
  APPROVED
  REJECTED
  RE_REVIEW_REQUIRED
}

enum AttorneyReviewAction {
  APPROVE
  REQUEST_INFO
  REJECT
  MARK_RE_REVIEW
  VERIFY
  UNVERIFY
  BAR_VERIFY
  BAR_UNVERIFY
}

enum ScoreSnapshotPeriod {
  DAILY
  WEEKLY
}

model User {
  id              String    @id @db.Uuid // 建议与 Supabase auth.users.id 对齐
  email           String    @unique
  role            UserRole
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  clientProfile   ClientProfile?
  attorneyProfile AttorneyProfile?
  chatMessages    ChatMessage[]
  disclaimerAcks  DisclaimerAcceptance[]
  conversationReportsSubmitted ConversationReport[] @relation("ReportReporter")
  conversationReportsHandled   ConversationReport[] @relation("ReportHandler")
  conversationReportsTargeted  ConversationReport[] @relation("ReportTarget")
  blacklistGiven    UserBlacklist[] @relation("BlacklistBlocker")
  blacklistReceived UserBlacklist[] @relation("BlacklistBlocked")
  blacklistsDeactivated UserBlacklist[] @relation("BlacklistDeactivator")
  reportAttachments ConversationReportAttachment[]
  adminActions      AdminActionLog[] @relation("AdminActionActor")
  caseImageAccessLogsAsViewer CaseImageAccessLog[] @relation("CaseImageAccessViewer")
  engagementsConfirmedAsAttorney EngagementConfirmation[] @relation("EngagementConfirmedByAttorney")
  engagementsConfirmedAsClient   EngagementConfirmation[] @relation("EngagementConfirmedByClient")
  followUpRemindersCreated AttorneyFollowUpReminder[] @relation("FollowUpCreator")
  disputeTicketsCreated DisputeTicket[] @relation("DisputeCreatedBy")
  disputeTicketsAssigned DisputeTicket[] @relation("DisputeAssignedAdmin")
  disputeTicketMessages DisputeTicketMessage[]
  contentRuleEvents ContentRuleEvent[] @relation("ContentRuleActor")
  paymentOrdersPaid PaymentOrder[] @relation("PaymentPayer")
  paymentOrdersReceived PaymentOrder[] @relation("PaymentPayee")
  paymentOrdersReconciled PaymentOrder[] @relation("PaymentReconciledBy")
  paymentOrdersRefundReviewed PaymentOrder[] @relation("PaymentRefundReviewedBy")
  paymentMilestonesReleaseReviewed PaymentMilestone[] @relation("MilestoneReleaseReviewedBy")
  paymentEventsActor PaymentEvent[] @relation("PaymentEventActor")
  conversationReadStates ConversationReadState[]
  notifications     UserNotification[] @relation("UserNotifications")
  supportTicketsCreated SupportTicket[] @relation("SupportTicketCreator")
  supportTicketsAssigned SupportTicket[] @relation("SupportTicketAssignee")
  supportTicketMessages SupportTicketMessage[]
  supportTicketAttachments SupportTicketAttachment[]
  supportInboxRoutingsAssigned SupportInboxRouting[] @relation("SupportInboxRoutingAssignee")
  replyTemplatesCreated ReplyTemplate[] @relation("ReplyTemplateCreator")
  replyTemplatesUpdated ReplyTemplate[] @relation("ReplyTemplateUpdater")
  attorneyReviewsPerformed AttorneyReviewLog[] @relation("AttorneyReviewAdmin")
  attorneyVerificationLogsPerformed AttorneyVerificationLog[] @relation("AttorneyVerificationAdmin")
  attorneysLastReviewed AttorneyProfile[] @relation("AttorneyLastReviewer")
  attorneyClientReviewsModerated AttorneyClientReview[] @relation("AttorneyClientReviewModerator")
  attorneyBadgesGranted AttorneyBadgeGrant[] @relation("AttorneyBadgeGrantedBy")
  attorneyNotificationPreference AttorneyNotificationPreference?

  @@index([role])
}

model AttorneyNotificationPreference {
  id                           String   @id @default(cuid())
  userId                       String   @unique @db.Uuid
  emailInstantHighPriority     Boolean  @default(true)
  emailInstantNewMessages      Boolean  @default(true)
  emailInstantCaseMatches      Boolean  @default(true)
  emailDailyDigest             Boolean  @default(true)
  emailWeeklyDigest            Boolean  @default(true)
  inAppP0                      Boolean  @default(true)
  inAppP1                      Boolean  @default(true)
  inAppP2                      Boolean  @default(true)
  inAppP3                      Boolean  @default(false)
  quietHoursEnabled            Boolean  @default(false)
  quietHoursStart              String?  // "22:00"
  quietHoursEnd                String?  // "08:00"
  preferredCaseCategories      String[] @default([])
  preferredBudgetMin           Decimal? @db.Decimal(10,2)
  preferredBudgetMax           Decimal? @db.Decimal(10,2)
  preferredFeeModes            String[] @default([])
  createdAt                    DateTime @default(now())
  updatedAt                    DateTime @updatedAt

  user                         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ClientProfile {
  id                String    @id @default(cuid())
  userId            String    @unique @db.Uuid
  firstName         String?
  lastName          String?
  phone             String?
  zipCode           String?   @db.VarChar(10)
  preferredLanguage Language?

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  cases             Case[]
  conversations     Conversation[] @relation("ConversationClient")
  caseImageAccessLogs CaseImageAccessLog[]
  engagements       EngagementConfirmation[]
  disputeTickets    DisputeTicket[] @relation("DisputeClient")
  paymentOrders     PaymentOrder[] @relation("PaymentClient")
  supportTickets    SupportTicket[]
  attorneyReviews   AttorneyClientReview[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model AttorneyProfile {
  id                String     @id @default(cuid())
  userId            String     @unique @db.Uuid
  firstName         String?
  lastName          String?
  phone             String?
  avatarUrl         String?
  firmName          String?
  barLicenseNumber  String?
  barNumberVerified Boolean    @default(false)
  barVerifiedAt     DateTime?
  barVerificationStatus VerificationStatus @default(PENDING)
  barVerificationNote String?
  barRegisteredName String?
  barState          String?    @db.Char(2)
  registeredLegalName String?
  identityVerificationStatus VerificationStatus @default(PENDING)
  identityDocumentType IdentityDocumentType?
  identityDocumentFileName String?
  identityDocumentPath String?
  identityVerifiedAt DateTime?
  identityVerificationNote String?
  phoneVerifiedAt    DateTime?
  emailVerifiedAt    DateTime?
  lawSchool         String?
  yearsExperience   Int?
  specialtyExperienceYears Json?
  bio               String?
  isVerified        Boolean    @default(false)
  reviewStatus      AttorneyReviewStatus @default(PENDING_REVIEW)
  reviewRequestedAt DateTime?
  lastReviewedAt    DateTime?
  lastReviewedByUserId String? @db.Uuid
  reviewDecisionTemplate String?
  reviewDecisionReason String?
  profileCompletenessScore Int  @default(0)
  reviewChecklistSnapshot Json?

  user              User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  serviceAreas      AttorneyServiceArea[]
  specialties       AttorneySpecialty[]
  languages         AttorneyLanguage[]
  bids              Bid[]
  conversations     Conversation[]    @relation("ConversationAttorney")
  caseImageAccessLogs CaseImageAccessLog[]
  engagements       EngagementConfirmation[]
  followUpReminders AttorneyFollowUpReminder[]
  checklistItems     ConversationChecklistItem[]
  conversationTags   ConversationTag[]
  disputeTickets     DisputeTicket[] @relation("DisputeAttorney")
  paymentOrders      PaymentOrder[] @relation("PaymentAttorney")
  reviewLogs         AttorneyReviewLog[]
  verificationLogs   AttorneyVerificationLog[]
  scoreSnapshots     AttorneyScoreSnapshot[]
  clientReviews      AttorneyClientReview[]
  showcaseCases      AttorneyCaseShowcase[]
  badges             AttorneyBadgeGrant[]
  lastReviewedBy     User?      @relation("AttorneyLastReviewer", fields: [lastReviewedByUserId], references: [id], onDelete: SetNull)

  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
}

enum AttorneyClientReviewStatus {
  PUBLISHED
  HIDDEN
}

enum VerificationStatus {
  PENDING
  VERIFIED
  NEEDS_INFO
  REJECTED
}

enum IdentityDocumentType {
  PASSPORT
  DRIVER_LICENSE
  STATE_ID
  OTHER
}

enum AttorneyShowcaseStatus {
  DRAFT
  PUBLISHED
  HIDDEN
}

enum AttorneyBadgeType {
  VERIFIED_IDENTITY
  BAR_VERIFIED
  TOP_RATED
  FAST_RESPONDER
  HIGH_CONVERSION
  LOW_DISPUTE_RATE
  MULTILINGUAL
  PREMIUM_MEMBER
}

enum AttorneyBadgeSource {
  SYSTEM
  MANUAL
}

model AttorneyClientReview {
  id                    String                    @id @default(cuid())
  attorneyId            String
  clientProfileId       String
  engagementId          String?
  caseId                String?
  status                AttorneyClientReviewStatus @default(PUBLISHED)
  ratingOverall         Int
  ratingResponsiveness  Int?
  ratingProfessionalism Int?
  ratingCommunication   Int?
  wouldRecommend        Boolean?
  comment               String?
  moderationReason      String?
  moderationLabels      Json?
  moderatedAt           DateTime?
  moderatedByUserId     String?                   @db.Uuid
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt

  attorney              AttorneyProfile           @relation(fields: [attorneyId], references: [id], onDelete: Cascade)
  client                ClientProfile             @relation(fields: [clientProfileId], references: [id], onDelete: Cascade)
  engagement            EngagementConfirmation?   @relation(fields: [engagementId], references: [id], onDelete: SetNull)
  case                  Case?                     @relation(fields: [caseId], references: [id], onDelete: SetNull)
  moderatedBy           User?                     @relation("AttorneyClientReviewModerator", fields: [moderatedByUserId], references: [id], onDelete: SetNull)

  @@index([attorneyId, status, createdAt])
  @@index([clientProfileId, createdAt])
  @@index([engagementId])
}

model AttorneyCaseShowcase {
  id                String               @id @default(cuid())
  attorneyId        String
  caseType          String
  summaryMasked     String
  serviceProvided   String
  outcomeCategory   String
  jurisdiction      String?
  year              Int?
  evidenceOptional  String?
  status            AttorneyShowcaseStatus @default(DRAFT)
  sortOrder         Int                  @default(0)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  attorney          AttorneyProfile      @relation(fields: [attorneyId], references: [id], onDelete: Cascade)

  @@index([attorneyId, status, sortOrder])
}

model AttorneyBadgeGrant {
  id                String             @id @default(cuid())
  attorneyId        String
  badgeType         AttorneyBadgeType
  source            AttorneyBadgeSource @default(SYSTEM)
  active            Boolean            @default(true)
  reason            String?
  grantedByUserId   String?            @db.Uuid
  grantedAt         DateTime           @default(now())
  expiresAt         DateTime?
  reviewedAt        DateTime?
  metadata          Json?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  attorney          AttorneyProfile    @relation(fields: [attorneyId], references: [id], onDelete: Cascade)
  grantedBy         User?              @relation("AttorneyBadgeGrantedBy", fields: [grantedByUserId], references: [id], onDelete: SetNull)

  @@index([attorneyId, active, badgeType])
  @@index([badgeType, active, createdAt])
}

model AttorneyReviewLog {
  id                 String               @id @default(cuid())
  attorneyId         String
  adminUserId        String?              @db.Uuid
  action             AttorneyReviewAction
  toStatus           AttorneyReviewStatus?
  templateKey        String?
  reason             String?
  checklistSnapshot  Json?
  completenessScore  Int?
  createdAt          DateTime             @default(now())

  attorney           AttorneyProfile      @relation(fields: [attorneyId], references: [id], onDelete: Cascade)
  adminUser          User?                @relation("AttorneyReviewAdmin", fields: [adminUserId], references: [id], onDelete: SetNull)

  @@index([attorneyId, createdAt])
  @@index([adminUserId, createdAt])
  @@index([action, createdAt])
}

model AttorneyVerificationLog {
  id                String               @id @default(cuid())
  attorneyId        String
  adminUserId       String?              @db.Uuid
  action            AttorneyReviewAction
  toStatus          AttorneyReviewStatus?
  templateKey       String?
  templateReply     String?
  reason            String?
  beforeSnapshot    Json?
  afterSnapshot     Json?
  fieldDiff         Json?
  checklistSnapshot Json?
  completenessScore Int?
  createdAt         DateTime             @default(now())

  attorney          AttorneyProfile      @relation(fields: [attorneyId], references: [id], onDelete: Cascade)
  adminUser         User?                @relation("AttorneyVerificationAdmin", fields: [adminUserId], references: [id], onDelete: SetNull)

  @@index([attorneyId, createdAt])
  @@index([adminUserId, createdAt])
  @@index([action, createdAt])
}

model AttorneyScoreSnapshot {
  id                       String             @id @default(cuid())
  attorneyId               String
  period                   ScoreSnapshotPeriod
  periodStart              DateTime
  periodEnd                DateTime
  bidsCount                Int                @default(0)
  acceptedBidsCount        Int                @default(0)
  conversationsCount       Int                @default(0)
  closedConversationsCount Int                @default(0)
  reportsCount             Int                @default(0)
  disputesCount            Int                @default(0)
  resolvedDisputesCount    Int                @default(0)
  refundLinkedCount        Int                @default(0)
  paymentOrdersCount       Int                @default(0)
  ruleHitCount             Int                @default(0)
  ruleBlockCount           Int                @default(0)
  activeBlacklistCount     Int                @default(0)
  avgFirstBidMinutes       Int?
  avgFirstMessageMinutes   Int?
  bidConversionRate        Float              @default(0)
  completionRate           Float              @default(0)
  disputeRate              Float              @default(0)
  complaintRate            Float              @default(0)
  refundLinkedRate         Float              @default(0)
  complianceRiskScore      Int                @default(0)
  qualityScore             Int                @default(0)
  metadata                 Json?
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt

  attorney                  AttorneyProfile    @relation(fields: [attorneyId], references: [id], onDelete: Cascade)

  @@unique([attorneyId, period, periodStart])
  @@index([period, periodStart])
  @@index([complianceRiskScore, periodStart])
  @@index([qualityScore, periodStart])
}

model OpsPrioritySetting {
  id                              String   @id @default(cuid())
  key                             String   @unique @default("default")
  highValueBaseWeight             Int      @default(30)
  highValueReasonWeight           Int      @default(5)
  firstBidOverduePublishedWeight  Int      @default(35)
  firstMessageOverdueWeight       Int      @default(25)
  quotedNotSelectedWeight         Int      @default(15)
  selectedNoConversationWeight    Int      @default(20)
  urgentWeight                    Int      @default(10)
  updatedAt                       DateTime @updatedAt
  createdAt                       DateTime @default(now())
}

model SupportInboxRouting {
  id                String                @id @default(cuid())
  sourceType         SupportInboxSourceType
  sourceId           String
  queueLevel         SupportInboxQueueLevel @default(CUSTOMER_SERVICE)
  assignedAdminUserId String?             @db.Uuid
  priorityOverride   String?
  slaDueAtOverride   DateTime?
  internalNote       String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  assignedAdmin      User?                @relation("SupportInboxRoutingAssignee", fields: [assignedAdminUserId], references: [id], onDelete: SetNull)

  @@unique([sourceType, sourceId])
  @@index([queueLevel, updatedAt])
  @@index([assignedAdminUserId, updatedAt])
}

model ReplyTemplate {
  id                  String   @id @default(cuid())
  scene               String
  title               String
  body                String
  active              Boolean  @default(true)
  sortOrder           Int      @default(0)
  createdByAdminUserId String? @db.Uuid
  updatedByAdminUserId String? @db.Uuid
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  createdBy           User?    @relation("ReplyTemplateCreator", fields: [createdByAdminUserId], references: [id], onDelete: SetNull)
  updatedBy           User?    @relation("ReplyTemplateUpdater", fields: [updatedByAdminUserId], references: [id], onDelete: SetNull)

  @@index([scene, active, sortOrder])
}

model AttorneyServiceArea {
  id          String           @id @default(cuid())
  attorneyId  String
  stateCode   String           @db.Char(2)
  zipCode     String?          @db.VarChar(10)

  attorney    AttorneyProfile  @relation(fields: [attorneyId], references: [id], onDelete: Cascade)

  @@index([attorneyId, stateCode])
  @@index([zipCode])
  @@unique([attorneyId, stateCode, zipCode])
}

model AttorneySpecialty {
  id          String           @id @default(cuid())
  attorneyId  String
  category    LegalCategory

  attorney    AttorneyProfile  @relation(fields: [attorneyId], references: [id], onDelete: Cascade)

  @@unique([attorneyId, category])
  @@index([category])
}

model AttorneyLanguage {
  id          String           @id @default(cuid())
  attorneyId  String
  language    Language

  attorney    AttorneyProfile  @relation(fields: [attorneyId], references: [id], onDelete: Cascade)

  @@unique([attorneyId, language])
}

model Case {
  id                  String        @id @default(cuid())
  clientProfileId     String?       // null = anonymous guest submission
  title               String
  category            LegalCategory
  subCategorySlug     String?       // law119-specific subcategory slug (do not reuse bangbang categories)
  stateCode           String        @db.Char(2)
  city                String?
  zipCode             String        @db.VarChar(10)
  description         String
  descriptionMasked   String?       // hall-visible redacted summary
  urgency             UrgencyLevel  @default(MEDIUM)
  preferredLanguage   Language
  feeMode             FeeMode       @default(CUSTOM)
  budgetMin           Decimal?      @db.Decimal(10, 2)
  budgetMax           Decimal?      @db.Decimal(10, 2)
  quoteDeadline       DateTime?
  selectedBidId       String?
  status              CaseStatus    @default(OPEN)
  contactPhone        String?       // client contact phone (anonymous cases)
  contactEmail        String?       // client contact email (anonymous cases)

  client              ClientProfile? @relation(fields: [clientProfileId], references: [id], onDelete: SetNull)
  bids                Bid[]
  conversations       Conversation[]
  images              CaseImage[]
  statusLogs          CaseStatusLog[]
  imageAccessLogs     CaseImageAccessLog[]
  engagementConfirmations EngagementConfirmation[]
  attorneyClientReviews AttorneyClientReview[]
  disputeTickets      DisputeTicket[]
  contentRuleEvents   ContentRuleEvent[]
  paymentOrders       PaymentOrder[]

  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  @@index([stateCode, category, status])
  @@index([category, zipCode, status])
  @@index([clientProfileId, createdAt])
}

model CaseImage {
  id          String   @id @default(cuid())
  caseId      String
  storagePath String   // Supabase storage path: case-images/{caseId}/{filename}
  url         String   // Signed or public URL
  mimeType    String?
  sizeBytes   Int?
  sortOrder   Int      @default(0)
  visibility  CaseAttachmentVisibility @default(SELECTED_ATTORNEY)
  isSensitive Boolean  @default(false)
  sensitiveHint String?

  case        Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  accessLogs  CaseImageAccessLog[]

  createdAt   DateTime @default(now())

  @@index([caseId])
}

model Bid {
  id                  String          @id @default(cuid())
  caseId              String
  attorneyProfileId   String
  message             String?
  feeQuoteMin         Decimal?        @db.Decimal(10, 2)
  feeQuoteMax         Decimal?        @db.Decimal(10, 2)
  feeMode             FeeMode         @default(CUSTOM)
  serviceScope        String?
  estimatedDays       Int?
  includesConsultation Boolean        @default(false)
  version             Int             @default(1)
  status              BidStatus       @default(PENDING)
  contactedAt         DateTime?

  case                Case            @relation(fields: [caseId], references: [id], onDelete: Cascade)
  attorney            AttorneyProfile @relation(fields: [attorneyProfileId], references: [id], onDelete: Cascade)
  conversation        Conversation?
  versions            BidVersion[]
  engagementConfirmations EngagementConfirmation[]
  disputeTickets      DisputeTicket[]
  contentRuleEvents   ContentRuleEvent[]
  paymentOrders       PaymentOrder[]

  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  // 防止同一律师对同一案件重复出价
  @@unique([caseId, attorneyProfileId])
  @@index([attorneyProfileId, status])
  @@index([caseId, status])
}

model BidVersion {
  id                   String    @id @default(cuid())
  bidId                String
  version              Int
  message              String?
  feeQuoteMin          Decimal?  @db.Decimal(10, 2)
  feeQuoteMax          Decimal?  @db.Decimal(10, 2)
  feeMode              FeeMode   @default(CUSTOM)
  serviceScope         String?
  estimatedDays        Int?
  includesConsultation Boolean   @default(false)
  status               BidStatus
  createdAt            DateTime  @default(now())

  bid                  Bid       @relation(fields: [bidId], references: [id], onDelete: Cascade)

  @@unique([bidId, version])
  @@index([bidId, createdAt])
}

model CaseStatusLog {
  id          String      @id @default(cuid())
  caseId       String
  fromStatus   CaseStatus?
  toStatus     CaseStatus
  operatorId   String?    @db.Uuid
  reason       String?
  createdAt    DateTime   @default(now())

  case         Case       @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId, createdAt])
}

model Conversation {
  id                    String              @id @default(cuid())
  bidId                 String              @unique
  caseId                String
  clientProfileId       String?             // null = anonymous guest case
  attorneyProfileId     String
  status                ConversationStatus  @default(OPEN)
  consultationAcceptedAt DateTime?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  bid                   Bid                 @relation(fields: [bidId], references: [id], onDelete: Cascade)
  case                  Case                @relation(fields: [caseId], references: [id], onDelete: Cascade)
  client                ClientProfile?      @relation("ConversationClient", fields: [clientProfileId], references: [id], onDelete: SetNull)
  attorney              AttorneyProfile     @relation("ConversationAttorney", fields: [attorneyProfileId], references: [id], onDelete: Cascade)
  messages              ChatMessage[]
  disclaimerAcceptances DisclaimerAcceptance[]
  reports               ConversationReport[]
  reportAttachments     ConversationReportAttachment[]
  blacklists            UserBlacklist[]
  engagementConfirmations EngagementConfirmation[]
  tags                  ConversationTag[]
  followUpReminders     AttorneyFollowUpReminder[]
  checklistItems        ConversationChecklistItem[]
  disputeTickets        DisputeTicket[]
  contentRuleEvents     ContentRuleEvent[]
  paymentOrders         PaymentOrder[]
  readStates            ConversationReadState[]

  @@index([attorneyProfileId, status, createdAt])
  @@index([clientProfileId, status, createdAt])
}

model ChatMessage {
  id            String         @id @default(cuid())
  conversationId String
  senderUserId  String?        @db.Uuid
  senderRole    ChatSenderRole
  body          String
  createdAt     DateTime       @default(now())

  conversation  Conversation   @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender        User?          @relation(fields: [senderUserId], references: [id], onDelete: SetNull)

  @@index([conversationId, createdAt])
}

model ConversationReport {
  id               String                   @id @default(cuid())
  conversationId   String
  reporterUserId   String                   @db.Uuid
  reporterRole     ConversationRole
  targetUserId     String?                  @db.Uuid
  targetRole       ConversationRole?
  reportedMessageId String?
  reportedMessageExcerpt String?
  category         ConversationReportCategory
  details          String?
  evidenceSnapshot Json?
  evidenceCount    Int?
  attachments      ConversationReportAttachment[]
  status           ConversationReportStatus @default(PENDING)
  adminNote        String?
  handledByUserId  String?                  @db.Uuid
  handledAt        DateTime?
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt

  conversation     Conversation             @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  reporter         User                     @relation("ReportReporter", fields: [reporterUserId], references: [id], onDelete: Cascade)
  targetUser       User?                    @relation("ReportTarget", fields: [targetUserId], references: [id], onDelete: SetNull)
  handledBy        User?                    @relation("ReportHandler", fields: [handledByUserId], references: [id], onDelete: SetNull)

  @@index([conversationId, createdAt])
  @@index([status, createdAt])
  @@index([reporterUserId, createdAt])
  @@index([reportedMessageId])
}

model UserBlacklist {
  id                String     @id @default(cuid())
  conversationId     String?
  scope             BlacklistScope @default(CONVERSATION)
  blockerUserId      String     @db.Uuid
  blockedUserId      String     @db.Uuid
  reason             String?
  active             Boolean    @default(true)
  expiresAt          DateTime?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  deactivatedAt      DateTime?
  deactivatedByUserId String?   @db.Uuid

  conversation       Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  blocker           User         @relation("BlacklistBlocker", fields: [blockerUserId], references: [id], onDelete: Cascade)
  blocked           User         @relation("BlacklistBlocked", fields: [blockedUserId], references: [id], onDelete: Cascade)
  deactivatedBy     User?        @relation("BlacklistDeactivator", fields: [deactivatedByUserId], references: [id], onDelete: SetNull)

  @@unique([blockerUserId, blockedUserId])
  @@index([active, createdAt])
  @@index([blockedUserId, active])
}

model ConversationReportAttachment {
  id             String             @id @default(cuid())
  reportId       String?
  conversationId String
  uploaderUserId String             @db.Uuid
  fileName       String?
  storagePath    String
  url            String
  mimeType       String?
  sizeBytes      Int?
  createdAt      DateTime           @default(now())

  report         ConversationReport? @relation(fields: [reportId], references: [id], onDelete: SetNull)
  conversation   Conversation        @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  uploader       User                @relation(fields: [uploaderUserId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([uploaderUserId, createdAt])
  @@index([reportId, createdAt])
}

model AdminActionLog {
  id          String               @id @default(cuid())
  adminUserId String               @db.Uuid
  entityType  AdminActionEntityType
  entityId    String
  action      String
  reason      String?
  metadata    Json?
  createdAt   DateTime             @default(now())

  admin       User                 @relation("AdminActionActor", fields: [adminUserId], references: [id], onDelete: Cascade)

  @@index([adminUserId, createdAt])
  @@index([entityType, entityId, createdAt])
  @@index([createdAt])
}

model CaseImageAccessLog {
  id               String   @id @default(cuid())
  caseImageId       String
  caseId            String
  viewerUserId      String   @db.Uuid
  viewerRole        UserRole
  attorneyProfileId String?
  clientProfileId   String?
  accessType        String
  reason            String?
  createdAt         DateTime @default(now())

  caseImage         CaseImage @relation(fields: [caseImageId], references: [id], onDelete: Cascade)
  case              Case      @relation(fields: [caseId], references: [id], onDelete: Cascade)
  viewer            User      @relation("CaseImageAccessViewer", fields: [viewerUserId], references: [id], onDelete: Cascade)
  attorneyProfile   AttorneyProfile? @relation(fields: [attorneyProfileId], references: [id], onDelete: SetNull)
  clientProfile     ClientProfile?   @relation(fields: [clientProfileId], references: [id], onDelete: SetNull)

  @@index([caseImageId, createdAt])
  @@index([caseId, createdAt])
  @@index([viewerUserId, createdAt])
}

model EngagementConfirmation {
  id                       String             @id @default(cuid())
  caseId                   String
  bidId                    String
  conversationId           String?
  clientProfileId          String?
  attorneyProfileId        String
  status                   EngagementStatus   @default(DRAFT)
  serviceBoundary          ServiceBoundaryType @default(CUSTOM)
  serviceScopeSummary      String
  stagePlan                String?
  feeMode                  FeeMode            @default(CUSTOM)
  feeAmountMin             Decimal?           @db.Decimal(10, 2)
  feeAmountMax             Decimal?           @db.Decimal(10, 2)
  includesConsultation     Boolean            @default(false)
  includesCourtAppearance  Boolean            @default(false)
  includesTranslation      Boolean            @default(false)
  includesDocumentFiling   Boolean            @default(false)
  nonLegalAdviceAck        Boolean            @default(false)
  noAttorneyClientRelationshipAck Boolean     @default(false)
  attorneyConflictChecked  Boolean            @default(false)
  attorneyConflictCheckNote String?
  attorneyConflictCheckedAt DateTime?
  attorneyConfirmedAt      DateTime?
  clientConfirmedAt        DateTime?
  confirmedByAttorneyUserId String?           @db.Uuid
  confirmedByClientUserId   String?           @db.Uuid
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt

  case                     Case               @relation(fields: [caseId], references: [id], onDelete: Cascade)
  bid                      Bid                @relation(fields: [bidId], references: [id], onDelete: Cascade)
  conversation             Conversation?      @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  client                   ClientProfile?     @relation(fields: [clientProfileId], references: [id], onDelete: SetNull)
  attorney                 AttorneyProfile    @relation(fields: [attorneyProfileId], references: [id], onDelete: Cascade)
  confirmedByAttorney      User?              @relation("EngagementConfirmedByAttorney", fields: [confirmedByAttorneyUserId], references: [id], onDelete: SetNull)
  confirmedByClient        User?              @relation("EngagementConfirmedByClient", fields: [confirmedByClientUserId], references: [id], onDelete: SetNull)
  paymentOrders            PaymentOrder[]
  attorneyClientReviews    AttorneyClientReview[]

  @@unique([bidId])
  @@index([caseId, status])
  @@index([attorneyProfileId, status])
  @@index([clientProfileId, status])
}

model ConversationTag {
  id               String             @id @default(cuid())
  conversationId    String
  attorneyProfileId String
  tag              ConversationTagType
  note             String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  conversation     Conversation       @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  attorney         AttorneyProfile    @relation(fields: [attorneyProfileId], references: [id], onDelete: Cascade)

  @@unique([conversationId, attorneyProfileId, tag])
  @@index([attorneyProfileId, tag, updatedAt])
}

model AttorneyFollowUpReminder {
  id                 String                @id @default(cuid())
  conversationId      String
  attorneyProfileId   String
  createdByUserId     String               @db.Uuid
  dueAt              DateTime
  status             FollowUpReminderStatus @default(OPEN)
  title              String
  note               String?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  completedAt        DateTime?

  conversation       Conversation          @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  attorney           AttorneyProfile       @relation(fields: [attorneyProfileId], references: [id], onDelete: Cascade)
  createdBy          User                  @relation("FollowUpCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)

  @@index([attorneyProfileId, status, dueAt])
  @@index([conversationId, status, dueAt])
}

model ConversationChecklistItem {
  id                 String     @id @default(cuid())
  conversationId      String
  attorneyProfileId   String
  title              String
  required           Boolean    @default(true)
  completed          Boolean    @default(false)
  completedAt        DateTime?
  note               String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  conversation       Conversation   @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  attorney           AttorneyProfile @relation(fields: [attorneyProfileId], references: [id], onDelete: Cascade)

  @@index([attorneyProfileId, completed, updatedAt])
  @@index([conversationId, completed, updatedAt])
}

model DisputeTicket {
  id                String              @id @default(cuid())
  caseId            String?
  bidId             String?
  conversationId    String?
  clientProfileId   String?
  attorneyProfileId String?
  createdByUserId   String              @db.Uuid
  status            DisputeTicketStatus @default(OPEN)
  priority          DisputeTicketPriority @default(MEDIUM)
  category          String
  title             String
  description       String
  assignedAdminUserId String?           @db.Uuid
  slaDueAt          DateTime?
  firstResponseAt   DateTime?
  resolvedAt        DateTime?
  closedAt          DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  case              Case?               @relation(fields: [caseId], references: [id], onDelete: SetNull)
  bid               Bid?                @relation(fields: [bidId], references: [id], onDelete: SetNull)
  conversation      Conversation?       @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  client            ClientProfile?      @relation("DisputeClient", fields: [clientProfileId], references: [id], onDelete: SetNull)
  attorney          AttorneyProfile?    @relation("DisputeAttorney", fields: [attorneyProfileId], references: [id], onDelete: SetNull)
  createdBy         User                @relation("DisputeCreatedBy", fields: [createdByUserId], references: [id], onDelete: Cascade)
  assignedAdmin     User?               @relation("DisputeAssignedAdmin", fields: [assignedAdminUserId], references: [id], onDelete: SetNull)
  messages          DisputeTicketMessage[]

  @@index([status, priority, createdAt])
  @@index([conversationId, createdAt])
  @@index([assignedAdminUserId, status, slaDueAt])
}

model DisputeTicketMessage {
  id             String   @id @default(cuid())
  ticketId       String
  senderUserId   String   @db.Uuid
  senderRole     UserRole
  body           String
  isTemplate     Boolean  @default(false)
  isInternalNote Boolean  @default(false)
  createdAt      DateTime @default(now())

  ticket         DisputeTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  sender         User          @relation(fields: [senderUserId], references: [id], onDelete: Cascade)

  @@index([ticketId, createdAt])
}

model ContentRuleEvent {
  id              String            @id @default(cuid())
  scope           ContentRuleScope
  action          ContentRuleAction
  ruleCode        String
  severity        String
  matchedText     String?
  note            String?
  actorUserId     String?           @db.Uuid
  caseId          String?
  bidId           String?
  conversationId  String?
  createdAt       DateTime          @default(now())

  actor           User?             @relation("ContentRuleActor", fields: [actorUserId], references: [id], onDelete: SetNull)
  case            Case?             @relation(fields: [caseId], references: [id], onDelete: SetNull)
  bid             Bid?              @relation(fields: [bidId], references: [id], onDelete: SetNull)
  conversation    Conversation?     @relation(fields: [conversationId], references: [id], onDelete: SetNull)

  @@index([scope, action, createdAt])
  @@index([ruleCode, createdAt])
  @@index([caseId, createdAt])
  @@index([conversationId, createdAt])
}

model ContentRuleConfig {
  id          String            @id @default(cuid())
  scope       ContentRuleScope
  ruleCode    String
  enabled     Boolean           @default(true)
  action      ContentRuleAction @default(WARN)
  severity    String            @default("MEDIUM")
  pattern     String
  patternType String            @default("regex") // regex / contains
  description String?
  sortOrder   Int               @default(0)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@unique([scope, ruleCode])
  @@index([scope, enabled, sortOrder])
}

model RecommendationConfig {
  key                         String   @id // e.g. "case_hall"
  enabled                     Boolean  @default(true)
  activeVariant               String   @default("A") // A / B
  abEnabled                   Boolean  @default(false)
  abRolloutPercent            Int      @default(50)

  weightUnquotedA             Int      @default(140)
  weightUnquotedB             Int      @default(160)
  weightQuoteableA            Int      @default(100)
  weightQuoteableB            Int      @default(90)
  weightSoonDeadlineA         Int      @default(70)
  weightSoonDeadlineB         Int      @default(85)
  weightUrgentA               Int      @default(80)
  weightUrgentB               Int      @default(90)
  weightHighA                 Int      @default(50)
  weightHighB                 Int      @default(55)
  weightCategoryMatchA        Int      @default(60)
  weightCategoryMatchB        Int      @default(75)
  weightStateMatchA           Int      @default(40)
  weightStateMatchB           Int      @default(45)
  weightRecencyMaxBoostA      Int      @default(30)
  weightRecencyMaxBoostB      Int      @default(25)
  weightBidCrowdingPenaltyA   Int      @default(8)   // per bid, capped by bidCrowdingPenaltyCap
  weightBidCrowdingPenaltyB   Int      @default(10)
  bidCrowdingPenaltyCapA      Int      @default(48)
  bidCrowdingPenaltyCapB      Int      @default(60)

  categoryWhitelist           Json?    // string[]
  categoryBlacklist           Json?    // string[]
  nonWhitelistPenalty         Int      @default(40)
  blacklistPenalty            Int      @default(180)
  whitelistBoost              Int      @default(20)

  attorneyExposureSoftCap     Int      @default(8)   // active workloads before penalty
  attorneyExposurePenaltyPerExtra Int  @default(20)

  highRiskPenalty             Int      @default(120)
  highRiskRuleHitThreshold    Int      @default(1)
  highRiskReportThreshold     Int      @default(1)
  highRiskDisputeThreshold    Int      @default(1)

  maxPerCategoryInTopN        Int      @default(4)   // exposure cap to avoid category monopoly
  categoryExposureWindow      Int      @default(12)

  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt
}

model PaymentOrder {
  id                String            @id @default(cuid())
  engagementId      String?
  caseId            String?
  bidId             String?
  conversationId    String?
  clientProfileId   String?
  attorneyProfileId String?
  payerUserId       String?           @db.Uuid
  payeeUserId       String?           @db.Uuid
  feeMode           FeeMode           @default(CUSTOM)
  status            PaymentOrderStatus @default(UNPAID)
  currency          String            @default("USD")
  amountTotal       Decimal           @db.Decimal(12, 2)
  amountHeld        Decimal           @db.Decimal(12, 2)
  amountReleased    Decimal           @db.Decimal(12, 2) @default(0)
  amountRefunded    Decimal           @db.Decimal(12, 2) @default(0)
  title             String
  scopeSnapshot     Json?
  holdBlockedByDispute Boolean        @default(false)
  holdReasonCode    PaymentHoldReasonCode? @default(OTHER)
  holdBlockedReason String?
  reconciliationStatus PaymentReconciliationStatus @default(UNRECONCILED)
  reconciliationNote String?
  reconciledAt      DateTime?
  reconciledByUserId String?          @db.Uuid
  refundReviewStatus PaymentReviewStatus @default(NONE)
  refundRequestedAt DateTime?
  refundReviewedAt  DateTime?
  refundReviewedByUserId String?      @db.Uuid
  refundReviewNote  String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  engagement        EngagementConfirmation? @relation(fields: [engagementId], references: [id], onDelete: SetNull)
  case              Case?             @relation(fields: [caseId], references: [id], onDelete: SetNull)
  bid               Bid?              @relation(fields: [bidId], references: [id], onDelete: SetNull)
  conversation      Conversation?     @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  client            ClientProfile?    @relation("PaymentClient", fields: [clientProfileId], references: [id], onDelete: SetNull)
  attorney          AttorneyProfile?  @relation("PaymentAttorney", fields: [attorneyProfileId], references: [id], onDelete: SetNull)
  payer             User?             @relation("PaymentPayer", fields: [payerUserId], references: [id], onDelete: SetNull)
  payee             User?             @relation("PaymentPayee", fields: [payeeUserId], references: [id], onDelete: SetNull)
  reconciledBy      User?             @relation("PaymentReconciledBy", fields: [reconciledByUserId], references: [id], onDelete: SetNull)
  refundReviewedBy  User?             @relation("PaymentRefundReviewedBy", fields: [refundReviewedByUserId], references: [id], onDelete: SetNull)
  milestones        PaymentMilestone[]
  events            PaymentEvent[]

  @@index([status, createdAt])
  @@index([engagementId, createdAt])
  @@index([conversationId, createdAt])
}

model PaymentMilestone {
  id             String               @id @default(cuid())
  paymentOrderId  String
  sortOrder      Int                  @default(0)
  title          String
  deliverable    String
  amount         Decimal              @db.Decimal(12, 2)
  targetDate     DateTime?
  status         PaymentMilestoneStatus @default(PENDING)
  releaseRequestedAt DateTime?
  releaseReviewStatus PaymentReviewStatus @default(NONE)
  releaseReviewRequestedAt DateTime?
  releaseReviewedAt DateTime?
  releaseReviewedByUserId String?      @db.Uuid
  releaseReviewNote String?
  releasedAt     DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  paymentOrder   PaymentOrder         @relation(fields: [paymentOrderId], references: [id], onDelete: Cascade)
  events         PaymentEvent[]
  releaseReviewedBy User?             @relation("MilestoneReleaseReviewedBy", fields: [releaseReviewedByUserId], references: [id], onDelete: SetNull)

  @@index([paymentOrderId, sortOrder])
  @@index([status, createdAt])
}

model PaymentEvent {
  id             String          @id @default(cuid())
  paymentOrderId  String
  milestoneId    String?
  actorUserId    String?         @db.Uuid
  type           PaymentEventType
  amount         Decimal?        @db.Decimal(12, 2)
  note           String?
  metadata       Json?
  createdAt      DateTime        @default(now())

  paymentOrder   PaymentOrder    @relation(fields: [paymentOrderId], references: [id], onDelete: Cascade)
  milestone      PaymentMilestone? @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  actor          User?           @relation("PaymentEventActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([paymentOrderId, createdAt])
  @@index([type, createdAt])
}

model ConversationReadState {
  id               String       @id @default(cuid())
  conversationId   String
  userId           String       @db.Uuid
  role             UserRole
  lastReadAt       DateTime?
  lastReadMessageId String?
  lastSeenAt       DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  conversation     Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId, updatedAt])
  @@index([conversationId, updatedAt])
}

model UserNotification {
  id             String             @id @default(cuid())
  userId          String             @db.Uuid
  type           NotificationType
  status         NotificationStatus  @default(UNREAD)
  title          String
  body           String?
  linkUrl        String?
  metadata       Json?
  readAt         DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  user           User               @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status, createdAt])
  @@index([type, createdAt])
}

model SupportTicket {
  id                 String               @id @default(cuid())
  createdByUserId    String               @db.Uuid
  assignedAdminUserId String?             @db.Uuid
  clientProfileId    String?
  status            SupportTicketStatus   @default(OPEN)
  priority          SupportTicketPriority @default(MEDIUM)
  category          SupportTicketCategory @default(GENERAL)
  subject           String
  latestMessageAt   DateTime?
  slaDueAt          DateTime?
  firstResponseAt   DateTime?
  resolvedAt        DateTime?
  closedAt          DateTime?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  createdBy         User                 @relation("SupportTicketCreator", fields: [createdByUserId], references: [id], onDelete: Cascade)
  assignedAdmin     User?                @relation("SupportTicketAssignee", fields: [assignedAdminUserId], references: [id], onDelete: SetNull)
  client            ClientProfile?       @relation(fields: [clientProfileId], references: [id], onDelete: SetNull)
  messages          SupportTicketMessage[]
  attachments       SupportTicketAttachment[]

  @@index([createdByUserId, status, updatedAt])
  @@index([assignedAdminUserId, status, updatedAt])
  @@index([status, priority, updatedAt])
}

model SupportTicketMessage {
  id             String     @id @default(cuid())
  ticketId       String
  senderUserId   String     @db.Uuid
  senderRole     UserRole
  body           String
  isInternalNote Boolean    @default(false)
  isTemplate     Boolean    @default(false)
  createdAt      DateTime   @default(now())

  ticket         SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  sender         User          @relation(fields: [senderUserId], references: [id], onDelete: Cascade)
  attachments    SupportTicketAttachment[]

  @@index([ticketId, createdAt])
  @@index([senderUserId, createdAt])
}

model SupportTicketAttachment {
  id             String    @id @default(cuid())
  ticketId       String
  messageId      String?
  uploaderUserId String    @db.Uuid
  fileName       String?
  storagePath    String
  url            String
  mimeType       String?
  sizeBytes      Int?
  createdAt      DateTime  @default(now())

  ticket         SupportTicket         @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  message        SupportTicketMessage? @relation(fields: [messageId], references: [id], onDelete: SetNull)
  uploader       User                  @relation(fields: [uploaderUserId], references: [id], onDelete: Cascade)

  @@index([ticketId, createdAt])
  @@index([messageId, createdAt])
  @@index([uploaderUserId, createdAt])
}

model DisclaimerAcceptance {
  id             String            @id @default(cuid())
  conversationId String
  userId         String            @db.Uuid
  role           ConversationRole
  acceptedAt     DateTime          @default(now())

  conversation   Conversation      @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId, role])
}

// 法律细分服务目录（纯配置数据，由 seed 写入）
model LegalSubCategory {
  id          String        @id @default(cuid())
  category    LegalCategory // 所属大类
  slug        String        @unique // e.g. "green-card-family"
  nameZh      String        // 中文名
  nameEn      String        // 英文名
  group       String?       // 二级分组，e.g. "家庭类移民"
  enabled     Boolean       @default(true)
  sortOrder   Int           @default(0)
  hot         Boolean       @default(false) // 是否显示在首页热门
  homepageFeatured      Boolean @default(false)
  homepageFeaturedOrder Int     @default(0)

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @default(now()) @updatedAt

  @@index([category])
  @@index([enabled, category, sortOrder])
  @@index([hot])
  @@index([homepageFeatured, homepageFeaturedOrder])
}

model FaqEntry {
  id            String      @id @default(cuid())
  audience      FaqAudience @default(GENERAL)
  category      String?
  question      String
  answer        String
  active        Boolean     @default(true)
  featured      Boolean     @default(false)
  sortOrder     Int         @default(0)
  createdByUserId String?   @db.Uuid
  updatedByUserId String?   @db.Uuid
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([audience, active, sortOrder])
  @@index([featured, active])
}

model LegalNoticeVersion {
  id              String          @id @default(cuid())
  noticeType      LegalNoticeType
  title           String
  versionLabel    String
  bodyMarkdown    String
  summary         String?
  status          LegalNoticeStatus @default(DRAFT)
  effectiveAt     DateTime?
  publishedAt     DateTime?
  supersedesId    String?
  createdByUserId String?         @db.Uuid
  updatedByUserId String?         @db.Uuid
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  supersedes      LegalNoticeVersion? @relation("LegalNoticeSupersedes", fields: [supersedesId], references: [id], onDelete: SetNull)
  newerVersions   LegalNoticeVersion[] @relation("LegalNoticeSupersedes")

  @@index([noticeType, status, updatedAt])
  @@index([noticeType, effectiveAt])
}
